<!DOCTYPE html>
<!--
Crafted with ♥ by Geert Barentsen, Thomas Barclay & Knicole colon at NASA Ames
in August 2015, using pelican-bootstrap and flatly.
-->
<html lang="en"
>

<head>
    <title>Understanding Crowding - TESS Science Support Center</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!--Custom meta data-->

    <meta name="dc.title" content="NASA - TESS Science Support Center" />
    <meta name="dc.format" content="text/html" />
    <meta name="dc.date.modified" content="2022-02-11" />
    <meta name="dc.language" content="en" />
    <meta name="dc.description" content="Resources and Information for Users of TESS Data" />
    <meta name="dc.identifier" content="https://heasarc.gsfc.nasa.gov/docs/tess/" />
    <meta name="dc.audience" content="Astronomers, Astrophysicists, Scientists, Researchers" />
    <meta name="dc.subject.discipline" content="Astrophysics, Astronomy" />
    <meta name="orgcode" content="667">
    <meta name="rno" content="Thomas.Barclay">
    <meta name="content-owner" content="Thomas.Barclay">
    <meta name="webmaster" content="Thomas.Barclay">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:description" content="Transiting Exoplanet Survey Satellite is a NASA Mission to Study Stars, Planets and Galaxies." />
    <meta name="twitter:title" content="NASA - TESS Science Support Center" />
    <meta name="twitter:site" content="@NASA_TESS" />
    <meta name="twitter:creator" content="@NASA_TESS" />
    <meta name="twitter:image" content="https://heasarc.gsfc.nasa.gov/docs/tess/images/logo-for-twitter.jpeg" />


    <link href="./images/favicon.png" rel="icon">

<link rel="canonical" href="./pages/understanding-crowding.html">

        <meta name="author" content="Thomas Barclay" />
        <meta name="description" content="Understanding Crowding in TESS data Welcome everyone to our TESS Lightkurve splinter session! Authors Rebekah Hounsell - Support scientist for TESS in the NASA GSFC GI Office. Download the notebook If you would like to download a copy of this notebook you can do so by clicking the link below DOWNLOAD …" />

    <meta property="og:site_name" content="TESS" />
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Understanding Crowding"/>
    <meta property="og:url" content="./pages/understanding-crowding.html"/>
    <meta property="og:description" content="Understanding Crowding in TESS data Welcome everyone to our TESS Lightkurve splinter session! Authors Rebekah Hounsell - Support scientist for TESS in the NASA GSFC GI Office. Download the notebook If you would like to download a copy of this notebook you can do so by clicking the link below DOWNLOAD …" />
        <meta property="og:image"
              content="./images/logo-for-twitter.jpeg"/>


    <!-- Why use Helvetica Neue when you can have Lato? -->
    <!-- Why use Lato when you can have Nunito? -->
    <link href="./theme/css/nunito.css" rel="stylesheet">

    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.cosmo.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/exoplanet_archive_icons.css" rel="stylesheet">
    <link href="./theme/css/mission_icons.css" rel="stylesheet">
<!--     <link href="./theme/css/photobanner.css" rel="stylesheet">
    <link href="./theme/css/slide-container.css" rel="stylesheet">
    <link href="./theme/css/slide-transition.css" rel="stylesheet"> 
    <link href="./theme/css/slide-transition2.css" rel="stylesheet">  -->
    
    <link href="./theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>

    <link href="./feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="TESS ATOM Feed"/>
    <link href="./feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="TESS RSS Feed"/>

</head>
<body>

<!-- Print a warning message that this is not the official site -->
<div class="container container-wide" style="background-color: #d35400; color: white; padding: 1.5em; font-weight: bold;">
  <div class="container">
   <i class="fa fa-warning fa-lg fa-margin"></i>
    This is the development version of the TESS Science Support Center website.
    For the live website, visit <a href="https://heasarc.gsfc.nasa.gov/docs/tess/">https://heasarc.gsfc.nasa.gov/docs/tess</a>
  </div>
</div>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">

  <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
<img src="./images/NASA_logo_vector_lg.png" width="32"/> TESS            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav navbar-nav">
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Mission <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="./objectives.html">Objectives</a></li>
                                <li><a href="./the-tess-space-telescope.html">Telescope</a></li>
                                <li><a href="./primary.html">Primary mission</a></li>
                                <li><a href="./extended.html">First Extended mission</a></li>
                                <li><a href="./second-extended.html">Second Extended mission</a></li>
                                <li><a href="./faq.html">FAQ</a></li>
                                <li><a href="./citizenscience.html">Citizen Science</a></li>
                                <li><a href="./gallery.html">Outreach resources</a></li>
                                <li><a href="./publications.html">Publications</a></li>
                                <li><a href="./media.html">Media Request</a></li>
                            </ul>
                        </li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Data & tools <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="./data-handling.html">Data pipeline</a></li>
                                <li><a href="./data-products.html">Data products</a></li>
                                <li><a href="./data-access.html">Data access</a></li>
                                <li><a href="./data-analysis-tools.html">Data analysis tools</a></li>
                                <li><a href="./community.html">Community products</a></li>
                                <li><a href="./community-tools.html">Community tools</a></li>
                                <li><a href="./documentation.html">Documentation</a></li>
                                <li><a href="./data_release_notes.html">Data release notes</a></li>
                            </ul>
                        </li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Observations <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="./observing-technical.html">Technical details</a></li>
                                <li><a href="./sector.html">Sector dates</a></li>
                                <li><a href="./approved-programs.html">Approved GI programs</a></li>
                            </ul>
                        </li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Proposing <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="./proposing-investigations.html">Guest Investigator Proposals</a></li>
                                <li><a href="./proposal-tools.html">Proposal & observation tools</a></li>
                                <li><a href="./ddt.html">Director's Discretionary Target program</a></li>
                                <li><a href="./proposal-templates.html">Proposal templates</a></li>
                            </ul>
                        </li>
            </ul>
            
            <ul class="nav navbar-nav">
                <li>
                    <a href="./helpdesk.html"><i class="fa fa-info-circle fa-lg"></i> Helpdesk</a>
                </li>
            </ul>
            
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->

<div class="container">
    <div class="row">
        <div class="col-lg-12">

    <div class="col-sm-12">
        <section id="content" class="body">
            <h1 class="entry-title">Understanding Crowding</h1>
            <div class="entry-content">
                <div class="section" id="understanding-crowding-in-tess-data">
<h2>Understanding Crowding in TESS data</h2>
<p>Welcome everyone to our <em>TESS</em> Lightkurve splinter session!</p>
<div class="section" id="authors">
<h3>Authors</h3>
<p><a class="reference external" href="https://heasarc.gsfc.nasa.gov/docs/tess/helpdesk.html">Rebekah Hounsell</a> -
Support scientist for <em>TESS</em> in the NASA GSFC GI Office.</p>
<img alt="" src="images/helpdesk.png" />
</div>
</div>
<div class="section" id="download-the-notebook">
<h2>Download the notebook</h2>
<p>If you would like to download a copy of this notebook you can do so by clicking the link below</p>
<p><a class="reference download internal" href="https://tessgi.github.io/TessGiWebsite/docs/tutorials/UnderstandingCrowding.ipynb">
<tt class="xref download docutils literal">
DOWNLOAD
</tt></a><p><div class="section" id="learning-goals">
<h3>Learning goals</h3>
<p>In this tutorial, we will teach the user about crowding in the <em>TESS</em>
data products and how to correct for it.</p>
<p>The splinter session assumes a basic knowledge of python and astronomy,
and will walk the user through several of the concepts outlined below:</p>
<ol class="arabic simple">
<li>Downloading and comparing LightCurve Object data</li>
<li>Examining a TargetPixel File (TPF) for crowding</li>
<li>Creating a light curve from a TPF</li>
<li>Removing the effects of scattered light and noise</li>
<li>Removing the effects of crowding</li>
</ol>
<p>This tutorial is designed for users that have previous experience with
<em>Lightkurve</em>.</p>
</div>
<div class="section" id="imports">
<h3>Imports</h3>
<p>This tutorial requires the use of specific packages: -
<a class="reference external" href="https://docs.lightkurve.org/index.html">Lightkurve</a> to work with
<em>TESS</em> data (v2.0.1) - <a class="reference external" href="https://matplotlib.org/">Matplotlib</a> for
plotting. - <a class="reference external" href="https://numpy.org">Numpy</a> for manipulating the data.</p>
</div>
<div class="section" id="first-time-users">
<h3>First time users</h3>
<p>If you are not that experienced with <em>Python</em>, or cannot download
<em>Lightkurve</em>, you can run this notebook as a <a class="reference external" href="https://colab.research.google.com/notebooks/intro.ipynb?utm_source=scs-index">Colab notebook</a>.
Colaboratory allows users to write and execute <em>Python</em> in your browser
with zero configuration required.</p>
<p>All you need is a Google account and to copy and paste in the following
command at the top of your colab notebook:</p>
<p><tt class="docutils literal">!pip install <span class="pre">git+https://github.com/lightkurve/lightkurve.git</span> <span class="pre">--quiet</span></tt></p>
<p>This downloads the <em>Lightkurve</em> package.</p>
<pre class="code ipython3 literal-block">
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">lightkurve</span> <span class="k">as</span> <span class="nn">lk</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">lightkurve.correctors</span> <span class="kn">import</span> <span class="n">RegressionCorrector</span><span class="p">,</span> <span class="n">DesignMatrix</span>
<span class="kn">from</span> <span class="nn">lightkurve.correctors</span> <span class="kn">import</span> <span class="n">PLDCorrector</span>
<span class="kn">import</span> <span class="nn">warnings</span>
</pre>
</div>
<div class="section" id="introduction-into-crowding">
<h3>Introduction into crowding</h3>
<p><em>TESS</em> photometry, while high-cadence and of high quality, does suffer
from crowding issues. A single <em>TESS</em> pixel corresponds to 21 arcseconds
(~0.35 arc min) on sky and the <em>TESS</em> Pixel Response Function (PRF) is
very large compared to the pixel. A target of interest may therefore be
contaminated by any number of neighboring objects, and it is important
that the light from these other objects be accounted for and removed.</p>
<p>For exoplanets, if this excess flux is not removed, it can cause a
decrease in the apparent planet transit depth and lead to a systematic
underestimation of the planet radii.</p>
<p><a class="reference external" href="https://docs.lightkurve.org/tutorials/1-getting-started/what-are-lightcurve-objects.html">LightCurve Objects</a>
have been corrected for this crowding via the data processing pipeline
developed by the Science Processing Operations Center (SPOC). A
description of this correction and its application is provided in
Section 2.3.11 of <a class="reference external" href="https://iopscience.iop.org/article/10.1086/667698/pdf">this paper</a>. The
correction however is applied only to the PDCSAP flux and not the SAP
flux.</p>
<p>The crowding correction applied focuses on two parameters: - The
crowding metric: This reflects what fraction of the flux in the aperture
is due to the target itself, not the nearby light sources. - The flux
fraction: Similar to excess flux leaking into the aperture, a fraction
of the PRF of the target may not be captured in it. To account for this
missing fraction, the flux fraction is computed.</p>
<p>If PDCSAP flux is not available, the user may apply the corrections
outlined below to remove not only the instrumental noise, but any
additional crowding effect.</p>
</div>
<div class="section" id="downloading-and-comparing-lightcurve-object-data">
<h3>1. Downloading and comparing LightCurve Object data</h3>
<p>In this tutorial we will be examining at the binary star system
<a class="reference external" href="https://en.wikipedia.org/wiki/WR_21a">WR21a</a>. Let’s first see if
there are any LightCurve objects avalible for download.</p>
<pre class="code ipython3 literal-block">
<span class="n">search_lk</span> <span class="o">=</span> <span class="n">lk</span><span class="o">.</span><span class="n">search_lightcurve</span><span class="p">(</span><span class="s2">&quot;WR21a&quot;</span><span class="p">)</span>
<span class="n">search_lk</span>
</pre>
SearchResult containing 4 data products.

<table id="table140492139049616">
<thead><tr><th>#</th><th>mission</th><th>year</th><th>author</th><th>exptime</th><th>target_name</th><th>distance</th></tr></thead>
<thead><tr><th></th><th></th><th></th><th></th><th>s</th><th></th><th>arcsec</th></tr></thead>
<tr><td>0</td><td>TESS Sector 09</td><td>2019</td><td><a href='https://archive.stsci.edu/hlsp/qlp'>QLP</a></td><td>1800</td><td>464570167</td><td>0.0</td></tr>
<tr><td>1</td><td>TESS Sector 10</td><td>2019</td><td><a href='https://archive.stsci.edu/hlsp/qlp'>QLP</a></td><td>1800</td><td>464570167</td><td>0.0</td></tr>
<tr><td>2</td><td>TESS Sector 36</td><td>2021</td><td><a href='https://heasarc.gsfc.nasa.gov/docs/tess/pipeline.html'>SPOC</a></td><td>120</td><td>464570167</td><td>0.0</td></tr>
<tr><td>3</td><td>TESS Sector 37</td><td>2021</td><td><a href='https://heasarc.gsfc.nasa.gov/docs/tess/pipeline.html'>SPOC</a></td><td>120</td><td>464570167</td><td>0.0</td></tr>
</table><p>OK, great! There are data for multiple sectors. For this tutorial, we
will examining data from Sector 36 which is provided by the SPOC. We can
download this via the following functions,</p>
<pre class="code ipython3 literal-block">
<span class="n">lc36</span> <span class="o">=</span> <span class="n">search_lk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
<span class="n">lc36</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre>
<pre class="literal-block">
&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fc6e008eed0&gt;
</pre>
<img alt="" src="images/UnderstandingCrowding/output_9_1.png" />
<p>This very clearly shows the transit of the system. The flux displayed is
the PDCSAP flux which has been fully corrected. Let’s see what the SAP
flux looks like in comparison. We can do this by specifying the column
in the plot function.</p>
<pre class="code ipython3 literal-block">
<span class="n">ax</span> <span class="o">=</span> <span class="n">lc36</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'PDCSAP'</span><span class="p">)</span>
<span class="n">lc36</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">'sap_flux'</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'SAP'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="mi">2290</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">2293</span><span class="p">)</span>
</pre>
<pre class="literal-block">
(2290, 2293)
</pre>
<img alt="" src="images/UnderstandingCrowding/output_11_1.png" />
<p>The above plot clearly indicates the significant difference in amplitude
between the PDCSAP and SAP flux. The plot illustrates how much of a
difference the flux fraction and crowding metric can change the absolute
magnitudes of the light curves.</p>
<p>Now we plot the normalized PDCSAP and SAP flux to show that the transit
depth has changed.</p>
<pre class="code ipython3 literal-block">
<span class="n">ax</span> <span class="o">=</span> <span class="n">lc36</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'PDCSAP'</span><span class="p">)</span>
<span class="n">lc36</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">'sap_flux'</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'SAP'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="mi">2290</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">2293</span><span class="p">)</span>
</pre>
<pre class="literal-block">
(2290, 2293)
</pre>
<img alt="" src="images/UnderstandingCrowding/output_13_1.png" />
<p>The transit depth of the SAP flux is not the same as the PDCSAP. This
difference is a good indication that the data suffers from crowding.</p>
</div>
<div class="section" id="examining-a-target-pixel-file-for-crowding">
<h3>2. Examining a Target Pixel File for crowding</h3>
<p>To fully appreciate how crowded our object is, we can examine its
surroundings via downloading and plotting the associated TargetPixel
File (TPF).</p>
<pre class="code ipython3 literal-block">
<span class="n">tpf</span> <span class="o">=</span> <span class="n">lk</span><span class="o">.</span><span class="n">search_targetpixelfile</span><span class="p">(</span><span class="s1">'WR21a'</span><span class="p">,</span> <span class="n">sector</span><span class="o">=</span><span class="mi">36</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">quality_bitmask</span><span class="o">=</span><span class="s1">'hard'</span><span class="p">)</span>
</pre>
<p>Note for this tutorial we are specifing the <tt class="docutils literal">quality_bitmask</tt> to be
<tt class="docutils literal">hard</tt>. This is to ensure that only good quality data is downloaded. We
can now plot our TPF and display the aperture mask that has been defined
by the SPOC for our object of interest.</p>
<pre class="code ipython3 literal-block">
<span class="n">tpf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">aperture_mask</span><span class="o">=</span><span class="n">tpf</span><span class="o">.</span><span class="n">pipeline_mask</span><span class="p">)</span>
</pre>
<pre class="literal-block">
&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fc702669590&gt;
</pre>
<img alt="" src="images/UnderstandingCrowding/output_18_1.png" />
<p>The above plot indicates that we are focusing on the right object, but
that it is indeed crowded by a much brighter star and as such, we need
to remove the contaminating flux.</p>
</div>
<div class="section" id="creating-a-light-curve-from-a-tpf">
<h3>3. Creating a light curve from a TPF</h3>
<p>To do this, we must first create the light curve of the object using the
default mask, as shown below.</p>
<pre class="code ipython3 literal-block">
<span class="n">tpf_lc</span> <span class="o">=</span> <span class="n">tpf</span><span class="o">.</span><span class="n">to_lightcurve</span><span class="p">(</span><span class="n">aperture_mask</span><span class="o">=</span><span class="n">tpf</span><span class="o">.</span><span class="n">pipeline_mask</span><span class="p">)</span>
<span class="n">tpf_lc</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre>
<pre class="literal-block">
&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fc730838450&gt;
</pre>
<img alt="" src="images/UnderstandingCrowding/output_20_1.png" />
<p>A quick glance at this light curve indicates that there are also long
term trends/noise that need to be removed before we can correct for
crowding.</p>
</div>
<div class="section" id="removing-the-effects-of-scattered-light-and-noise">
<h3>4. Removing the effects of scattered light and noise</h3>
<p>As indicated above, the SAP light curve is effected by scattered light
and noise. We must remove this before correcting for crowding. To do
this, we can used one of <em>Lighkurves</em> built in corrector functions, in
this case <a class="reference external" href="https://docs.lightkurve.org/tutorials/2-creating-light-curves/2-3-k2-pldcorrector.html">Pixel Level Decorrelation (PLD)</a>.</p>
<p>The inputs required are the TPF, the aperture, and the number of
principal componants.</p>
<pre class="code ipython3 literal-block">
<span class="n">pld</span> <span class="o">=</span> <span class="n">PLDCorrector</span><span class="p">(</span><span class="n">tpf</span><span class="p">,</span> <span class="n">aperture_mask</span><span class="o">=</span><span class="n">tpf</span><span class="o">.</span><span class="n">pipeline_mask</span><span class="p">)</span>
<span class="n">pld</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">pca_components</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">pltAxis</span> <span class="o">=</span> <span class="n">pld</span><span class="o">.</span><span class="n">diagnose</span><span class="p">()</span>
<span class="n">pltAxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>
<span class="n">pltAxis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>
<span class="n">pltAxis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>


<span class="n">pld</span><span class="o">.</span><span class="n">diagnose_masks</span><span class="p">();</span>
<span class="n">pld_lc</span> <span class="o">=</span> <span class="n">pld</span><span class="o">.</span><span class="n">correct</span><span class="p">(</span><span class="n">pca_components</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">aperture_mask</span><span class="o">=</span><span class="n">tpf</span><span class="o">.</span><span class="n">pipeline_mask</span><span class="p">)</span>
</pre>
<img alt="" src="images/UnderstandingCrowding/output_23_1.png" />
<img alt="" src="images/UnderstandingCrowding/output_23_2.png" />
<p>Lets compare this corrected light curve with our previous light curves.</p>
<pre class="code ipython3 literal-block">
<span class="n">ax</span> <span class="o">=</span> <span class="n">lc36</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'PDCSAP'</span><span class="p">)</span>
<span class="n">tpf_lc</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'SAP ORIGINAL'</span><span class="p">)</span>
<span class="n">pld_lc</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'PLD SAP'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="mi">2290</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">2293</span><span class="p">)</span>
</pre>
<pre class="literal-block">
(2290, 2293)
</pre>
<img alt="" src="images/UnderstandingCrowding/output_25_1.png" />
<p>The depth of the PLD SAP light curve still does not match that of the
PDCSAP, but there is some improvement in the light curve overall. Let’s
now apply the crowding correction to the pld_lc.</p>
</div>
<div class="section" id="removing-the-effects-of-crowding">
<h3>5. Removing the effects of crowding</h3>
<p>To do this, we must first pull out the two parameters we need to
calculate the correction - CROWDSAP and FLFRCSAP</p>
<pre class="code ipython3 literal-block">
<span class="n">CROWDSAP</span> <span class="o">=</span> <span class="n">tpf</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'CROWDSAP'</span><span class="p">]</span>
</pre>
<pre class="code ipython3 literal-block">
<span class="n">CROWDSAP</span>
</pre>
<pre class="literal-block">
0.78926158
</pre>
<pre class="code ipython3 literal-block">
<span class="n">FLFRCSAP</span> <span class="o">=</span> <span class="n">tpf</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'FLFRCSAP'</span><span class="p">]</span>
</pre>
<pre class="code ipython3 literal-block">
<span class="n">FLFRCSAP</span>
</pre>
<pre class="literal-block">
0.7079128
</pre>
<p>From the above values, we see that the aperture contains only 71% of the
object’s flux, and an extra 21% of the flux in the aperture is due to
other objects.</p>
<p>To correct for the crowding and missing flux, we must first calculate
the median flux of our time series. Note that we want only data that is
of a high quality, which is why we originally set our <tt class="docutils literal">quality_mask</tt>
as hard.</p>
<pre class="code ipython3 literal-block">
<span class="n">median_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">pld_lc</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre>
<p>The excess flux in the aperture is then calculated as (1-CROWDSAP) times
the median flux</p>
<pre class="code ipython3 literal-block">
<span class="n">excess_flux</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">CROWDSAP</span><span class="p">)</span><span class="o">*</span><span class="n">median_flux</span>
</pre>
<p>This excess flux must then be subtracted from the time series data</p>
<pre class="code ipython3 literal-block">
<span class="n">flux_removed</span> <span class="o">=</span> <span class="n">pld_lc</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span>  <span class="o">-</span> <span class="n">excess_flux</span>
</pre>
<p>This residual flux, however, does not account for the flux of our object
outside of the aperture, as such there is one more correction to apply -
FLFRCSA.</p>
<pre class="code ipython3 literal-block">
<span class="n">flux_corr</span> <span class="o">=</span> <span class="n">flux_removed</span><span class="o">/</span><span class="n">FLFRCSAP</span>
</pre>
<p>The uncertainties on this flux are also now altered to be</p>
<pre class="code ipython3 literal-block">
<span class="n">flux_err_corr</span> <span class="o">=</span> <span class="n">pld_lc</span><span class="o">.</span><span class="n">flux_err</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="n">FLFRCSAP</span>
</pre>
<p>We can now convert this into a LightCurve Object again via the following</p>
<pre class="code ipython3 literal-block">
<span class="n">lc_corr</span> <span class="o">=</span> <span class="n">lk</span><span class="o">.</span><span class="n">LightCurve</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">tpf</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="n">flux_corr</span><span class="p">,</span> <span class="n">flux_err</span><span class="o">=</span><span class="n">flux_err_corr</span><span class="p">)</span>
</pre>
<p>Let’s plot and compare to our previous light curves.</p>
<pre class="code ipython3 literal-block">
<span class="n">ax</span> <span class="o">=</span> <span class="n">lc36</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'PDCSAP'</span><span class="p">)</span>
<span class="n">tpf_lc</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'SAP ORIGINAL'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">pld_lc</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'PLD SAP'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">lc_corr</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'PLD SAP CORR'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="mi">2290</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">2293</span><span class="p">)</span>
</pre>
<pre class="literal-block">
(2290, 2293)
</pre>
<img alt="" src="images/UnderstandingCrowding/output_45_1.png" />
<pre class="code ipython3 literal-block">
<span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">lc_corr</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre>
<pre class="literal-block">
8574.747152437736
</pre>
<p>The corrected light curve is now significantly closer to that of the
PLDSAP light curve. There are still some minor descrpancies, but these
are are realated primarily to the removal of noise. Adjustments in the
noise removal procedure applied to the SAP light curve can further
improve this reduction.</p>
<p>Let’s try another method - the CBV corrector.</p>
</div>
<div class="section" id="cbvcorrector">
<h3>CBVCorrector</h3>
<pre class="code ipython3 literal-block">
<span class="kn">from</span> <span class="nn">lightkurve.correctors</span> <span class="kn">import</span> <span class="n">CBVCorrector</span>
<span class="n">cbvCorrector</span> <span class="o">=</span> <span class="n">CBVCorrector</span><span class="p">(</span><span class="n">tpf_lc</span><span class="p">)</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">cbvs</span>
</pre>
<pre class="literal-block">
[TESS CBVs, Sector.Camera.CCD : 36.3.1, CBVType : SingleScale, nCBVS : 16,
 TESS CBVs, Sector.Camera.CCD : 36.3.1, CBVType.Band: MultiScale.1, nCBVs : 8,
 TESS CBVs, Sector.Camera.CCD : 36.3.1, CBVType.Band: MultiScale.2, nCBVs : 8,
 TESS CBVs, Sector.Camera.CCD : 36.3.1, CBVType.Band: MultiScale.3, nCBVs : 8,
 TESS CBVs, Sector.Camera.CCD : 36.3.1, CBVType : Spike, nCBVS : 6]
</pre>
<pre class="code ipython3 literal-block">
<span class="c1"># Select which CBVs to use in the correction</span>
<span class="n">cbv_type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'SingleScale'</span><span class="p">,</span> <span class="s1">'Spike'</span><span class="p">]</span>
<span class="n">cbv_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span> <span class="s1">'ALL'</span><span class="p">]</span>
<span class="c1"># Perform the correction</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">correct_gaussian_prior</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">diagnose</span><span class="p">();</span>
</pre>
<img alt="" src="images/UnderstandingCrowding/output_49_0.png" />
<p>Let’s check to see if we have over or underfit the data.</p>
<pre class="code ipython3 literal-block">
<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
    <span class="c1"># ignore &quot;RuntimeWarning&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
    <span class="n">cbvCorrector</span><span class="o">.</span><span class="n">goodness_metric_scan_plot</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">);</span>
</pre>
<img alt="" src="images/UnderstandingCrowding/output_51_0.png" />
<p>We might be slightly overfitting, so let’s adjust our alpha.</p>
<pre class="code ipython3 literal-block">
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">correct_gaussian_prior</span><span class="p">(</span><span class="n">cbv_type</span><span class="o">=</span><span class="n">cbv_type</span><span class="p">,</span> <span class="n">cbv_indices</span><span class="o">=</span><span class="n">cbv_indices</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">)</span>
<span class="n">cbvCorrector</span><span class="o">.</span><span class="n">diagnose</span><span class="p">();</span>
</pre>
<img alt="" src="images/UnderstandingCrowding/output_53_0.png" />
<p>Now we can apply the crowding corrections.</p>
<pre class="code ipython3 literal-block">
<span class="c1"># Perform the FF and CM corrections</span>
<span class="n">median_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">cbvCorrector</span><span class="o">.</span><span class="n">corrected_lc</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="n">excess_flux</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">CROWDSAP</span><span class="p">)</span><span class="o">*</span><span class="n">median_flux</span>
<span class="n">flux_removed</span> <span class="o">=</span> <span class="n">cbvCorrector</span><span class="o">.</span><span class="n">corrected_lc</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span>  <span class="o">-</span> <span class="n">excess_flux</span>
<span class="n">flux_corr</span> <span class="o">=</span> <span class="n">flux_removed</span><span class="o">/</span><span class="n">FLFRCSAP</span>
<span class="n">flux_err_corr</span> <span class="o">=</span> <span class="n">cbvCorrector</span><span class="o">.</span><span class="n">corrected_lc</span><span class="o">.</span><span class="n">flux_err</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="n">FLFRCSAP</span>
<span class="n">lc_cbv_corr</span> <span class="o">=</span> <span class="n">lk</span><span class="o">.</span><span class="n">LightCurve</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">tpf</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="n">flux_corr</span><span class="p">,</span> <span class="n">flux_err</span><span class="o">=</span><span class="n">flux_err_corr</span><span class="p">)</span>
</pre>
<p>We can now compare to the PDCSAP and SAP light curves.</p>
<pre class="code ipython3 literal-block">
<span class="n">ax</span> <span class="o">=</span> <span class="n">tpf_lc</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'SAP ORIGINAL'</span><span class="p">)</span>
<span class="n">lc36</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'PDCSAP'</span><span class="p">)</span>
<span class="n">lc_cbv_corr</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'cyan'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'CBV Corrected'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="mi">2290</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">2293</span><span class="p">);</span>
</pre>
<img alt="" src="images/UnderstandingCrowding/output_57_0.png" />
<p>Finally, we can compare our PLD and CBV corrected light curves.</p>
<pre class="code ipython3 literal-block">
<span class="n">ax</span> <span class="o">=</span> <span class="n">lc36</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'PDCSAP'</span><span class="p">)</span>
<span class="n">lc_cbv_corr</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'cyan'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'CBV Corrected'</span><span class="p">)</span>
<span class="n">lc_corr</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'PLD SAP CORR'</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Comparing PLD correction to CBV Correction'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="mi">2290</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">2293</span><span class="p">);</span>
</pre>
<img alt="" src="images/UnderstandingCrowding/output_59_0.png" />
<p>The CBV light curve might be a better match to the PDCSAP.</p>
</div>
</div>

            </div>
        </section>
    </div>

        </div>
    </div>
</div>

<div class="container container-wide" style="margin-top: 1.5em;">
  <footer>

     <div class="container">

      <!-- Partner logos -->  
      <div class="row">
        <div class="col-md-10"> 
          <a href="http://tess.mit.edu/"><img src="./images/partners/mit-logo.png" width="80" alt="MIT Logo"></a> &nbsp;&nbsp;&nbsp;
         <a href="http://www.nasa.gov/"><img src="./images/NASA_logo_vector_lg.png" width="60" alt="NASA Logo"></a> &nbsp;&nbsp;&nbsp;
         <a href="https://www.cfa.harvard.edu/"><img src="./images/partners/CfA_Horizontal_CMYK.png" width="176" alt="CfA Logo"></a> &nbsp;&nbsp;&nbsp;
<!--          <a href="https://www.ll.mit.edu/"><img src="./images/partners/lincoln-laboratory.png" width="50" alt="Lincoln Labs Logo"></a> &nbsp;&nbsp;&nbsp; -->
         <a href="https://http://www.northropgrumman.com/"><img src="./images/partners/Northrop_Grumman.png" width="176" alt="Orbital ATK Logo"></a> &nbsp;&nbsp;&nbsp;
         <a href="http://www.stsci.edu/"><img src="./images/partners/stsci_logo2.png" width="110" alt="STScI Logo"></a> 
        </div>
      </div>

      
      <!-- Related websites -->  
      <div class="row">
        <div class="col-xs-12">
          <h5><i class="fa fa-external-link"></i><span class="icon-label">Related websites:</span></h5>
          <a href="https://nasa.gov/tess" target="_blank">
                  News, Media, and Education Resources
              </a>
          <br/>
          <a href="http://tess.mit.edu/" target="_blank">
                  TESS @ MIT
              </a>
          <br/>
          <a href="http://archive.stsci.edu/tess" target="_blank">
                  TESS @ MAST
              </a>
          <br/>
          <a href="https://heasarc.gsfc.nasa.gov/" target="_blank">
                  High Energy Astrophysics Science Archive Research Center
              </a>
          <br/>
          <a href="http://exoplanetarchive.ipac.caltech.edu" target="_blank">
                  NASA Exoplanet Archive @ IPAC
              </a>
          <br/>
        </div>
      </div>

      <!-- NASA logo and notices -->
      <div class="row" style="margin-top:2em;">
         <div class="col-md-10"> <a href="http://www.nasa.gov/"><img src="./images/NASA_logo_vector_lg.png" width="30" alt="NASA Logo"></a> 
         Last modified: Mon 31 January 2022
            &middot; Editor: Thomas Barclay &middot; NASA Official: Patricia T Boyd 
            &middot; <a href="http://www.nasa.gov/about/highlights/HP_Privacy.html">Privacy Policy and Important Notices</a><p></p>         </div>
         <div class="col-md-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
    </div>

  </footer>
</div>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>

    <script src="./theme/js/bodypadding.js"></script>
<!-- Analytics scripts -->


</body>
</html>